<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Bulks — App Profissional</title>

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
  :root{
    --bg-dark: #012C3D;
    --accent: #D9A24A; /* dourado */
    --card:#ffffff;
    --muted:#7b8a93;
    --rounded:14px;
  }
  *{box-sizing:border-box}
  html,body{height:100%;margin:0;font-family:Inter, "Segoe UI", Roboto, Arial, sans-serif;background:linear-gradient(180deg,#012C3D 0%, #053a4b 120%);color:#0b1b22}
  .wrap{max-width:980px;margin:24px auto;padding:20px;}
  .app{
    max-width:420px;margin:0 auto;background:var(--card);border-radius:18px;overflow:hidden;box-shadow:0 16px 40px rgba(2,8,23,0.45);
    display:flex;flex-direction:column;
  }

  /* Splash */
  .splash{
    display:flex;flex-direction:column;align-items:center;justify-content:center;padding:42px;background:linear-gradient(135deg,#013b55,#0b6b9b);color:white;
    text-align:center;
  }
  .logo-mark{width:92px;height:92px;border-radius:24px;display:flex;align-items:center;justify-content:center;background:linear-gradient(180deg,#D9A24A,#b67f2f);box-shadow:0 8px 20px rgba(0,0,0,.25);font-weight:700;font-size:26px;color:#012C3D}
  .app-title{font-size:20px;margin-top:14px;font-weight:700;letter-spacing:0.3px}
  .app-sub{margin-top:6px;opacity:0.9;font-size:13px}
  .enter-btn{margin-top:18px;padding:12px 20px;border-radius:12px;background:white;color:var(--bg-dark);font-weight:700;border:none;cursor:pointer;box-shadow:0 6px 18px rgba(2,8,23,0.25)}
  .enter-btn:active{transform:translateY(1px)}

  /* content */
  .content{padding:18px 18px 26px;background:#f8fbfc}
  label{display:block;font-size:13px;color:#233; margin-top:10px;font-weight:600}
  input[type="text"], select, .small-input{
    width:100%;padding:12px;border-radius:10px;border:1px solid #e2eaed;font-size:15px;background:white;margin-top:8px;
  }
  .row{display:flex;gap:10px}
  .col{flex:1}

  .primary{
    margin-top:14px;padding:12px;background:var(--bg-dark);color:white;border-radius:12px;border:none;font-weight:700;cursor:pointer;width:100%;
    box-shadow:0 8px 20px rgba(1,44,61,0.18)
  }
  .ghost{margin-top:8px;padding:10px;background:transparent;border-radius:10px;border:1px solid #e4eef4;color:#012C3D;cursor:pointer;width:100%}
  .muted{color:var(--muted);font-size:13px}

  /* selection */
  .selection{display:flex;gap:10px;margin-top:12px}
  .card{flex:1;padding:14px;border-radius:12px;background:linear-gradient(180deg,#fff,#f7fbfc);border:1px solid #eef6f9;text-align:center;cursor:pointer}
  .card h3{margin:4px 0 0;font-size:16px;color:var(--bg-dark)}
  .card p{margin:6px 0 0;color:var(--muted);font-size:13px}

  /* control screen */
  .header-bar{display:flex;align-items:center;justify-content:space-between;gap:10px;padding:12px;border-radius:12px;background:linear-gradient(90deg,#012C3D,#025a72);color:white;margin-bottom:12px}
  .big-counter{font-size:48px;font-weight:800;color:#fff;text-align:center;margin:10px 0}
  .ctrl-btn{padding:14px;border-radius:12px;border:none;font-weight:800;cursor:pointer;background:linear-gradient(180deg,#D9A24A,#b67f2f);color:#012C3D;width:100%}
  .ctrl-secondary{background:#eef6f9;color:#012C3D;border-radius:12px;padding:10px;border:1px solid #e6f1f4;cursor:pointer}

  /* list */
  .list{max-height:360px;overflow:auto;border-radius:10px;border:1px solid #eef6f9;padding:8px;background:white;margin-top:12px}
  .item{display:grid;grid-template-columns:56px 1fr 110px;gap:8px;align-items:center;padding:8px;border-bottom:1px dashed #edf6f8}
  .item:last-child{border-bottom:none}
  .item .num{font-weight:700;color:#012C3D}
  .toggle{display:flex;gap:8px;align-items:center}
  .small-select{width:100%;padding:8px;border-radius:8px;border:1px solid #eef6f9;background:white}

  /* footer actions */
  .footer-actions{display:flex;gap:8px;margin-top:12px}
  .tiny{padding:8px;border-radius:10px;background:#012C3D;color:white;border:none;flex:1;cursor:pointer}
  .tiny.ghost{background:white;color:#012C3D;border:1px solid #e9f3f6}

  /* dashboard */
  .dash{display:flex;gap:12px;margin-top:12px}
  .dash-card{flex:1;padding:10px;border-radius:10px;background:white;border:1px solid #eef6f9;text-align:center}
  .dash-card h4{margin:2px;font-size:13px;color:#012C3D}
  .dash-card p{margin:0;font-size:20px;font-weight:700;color:#024f63}

  /* small */
  .small{font-size:12px;color:var(--muted)}
  .center{text-align:center}
  @media (max-width:480px){ .wrap{padding:10px} .app{margin:8px} .big-counter{font-size:40px} }

</style>
</head>
<body>
<div class="wrap">
  <div class="app" id="app">

    <!-- SPLASH / INTRO -->
    <div id="splash" class="splash">
      <div class="logo-mark">LOG20</div>
      <div class="app-title">Controle de Bulks</div>
      <div class="app-sub">Substitua a folha: registre recebimento, RTs, e gere relatórios</div>
      <button class="enter-btn" id="enter">Entrar</button>
      <div class="muted small" style="margin-top:12px">Versão demo — teste até 50 bulks. Dados salvos localmente.</div>
    </div>

    <!-- MAIN CONTENT -->
    <div id="main" class="content" style="display:none">

      <!-- STEP 1 - HEADER / SETUP -->
      <div id="setup">
        <label>Conferente / Operador</label>
        <input type="text" id="operator" placeholder="Digite seu nome">

        <label>Turno</label>
        <select id="turnoSel">
          <option value="">Selecione o turno...</option>
          <option value="A">Turno A</option>
          <option value="B">Turno B</option>
          <option value="C">Turno C</option>
        </select>

        <div class="row">
          <div class="col">
            <label>Data</label>
            <input type="text" id="date" class="small-input" readonly>
          </div>
          <div class="col">
            <label>Linha de Produção</label>
            <input type="text" id="linha" placeholder="Ex: 592">
          </div>
        </div>

        <label>Código do Material</label>
        <input type="text" id="codMat" placeholder="Ex: 20002807">

        <button class="primary" id="startBtn">Iniciar Controle</button>
      </div>

      <!-- STEP 2 - SELECTION -->
      <div id="selection" style="display:none">
        <h2 class="center" style="margin:8px 0 6px;color:#012C3D">Escolha o tipo de Bulk</h2>
        <div class="selection">
          <div class="card" id="chooseStella">
            <h3>Bulk Stella</h3>
            <p class="small">Empilhadeira 4 garfos – sai 2 bulks por vez</p>
          </div>
          <div class="card" id="chooseSpaten">
            <h3>Bulk Spaten</h3>
            <p class="small">Empilhadeira 4 garfos – sai 2 bulks por vez</p>
          </div>
        </div>
        <button class="ghost" id="backToSetup">Voltar</button>
      </div>

      <!-- STEP 3 - CONTROL SCREEN -->
      <div id="control" style="display:none">
        <div class="header-bar">
          <div>
            <div style="font-weight:700;font-size:14px" id="hdrTipo">Bulk</div>
            <div class="small" id="hdrMeta">Operador • Turno • Linha</div>
          </div>
          <div class="small center">
            <div style="font-size:11px;color:#eaf6ff">Registrado</div>
            <div id="totalRegistered" style="font-weight:800;font-size:18px;color:#fff;margin-top:6px">0</div>
          </div>
        </div>

        <!-- counter + quick add -->
        <div>
          <div class="big-counter" id="bigCounter">0</div>
          <div class="row">
            <button class="ctrl-btn" id="addBulk">Registrar Saída (+2)</button>
            <button class="ctrl-secondary" id="resetCounts" style="width:120px;margin-left:6px">Zerar</button>
          </div>
        </div>

        <!-- dashboard -->
        <div class="dash">
          <div class="dash-card">
            <h4>Total Stella</h4>
            <p id="dashStella">0</p>
          </div>
          <div class="dash-card">
            <h4>Total Spaten</h4>
            <p id="dashSpaten">0</p>
          </div>
        </div>

        <!-- list of items 1..50 -->
        <div class="list" id="listContainer" aria-live="polite">
          <!-- items injected by JS -->
        </div>

        <!-- footer actions -->
        <div class="footer-actions">
          <button class="tiny" id="exportCsv">Exportar CSV</button>
          <button class="tiny ghost" id="openReport">Visualizar Relatório</button>
          <button class="tiny" id="exportPdf">Exportar PDF</button>
        </div>

        <button class="ghost" id="backToSelect" style="margin-top:12px">Voltar</button>
      </div>

      <!-- REPORT PREVIEW modal-like -->
      <div id="reportPreview" style="display:none;padding-top:8px">
        <h3 style="margin:8px 0 6px;color:#012C3D">Relatório — Visualização</h3>
        <div style="background:#fff;border-radius:10px;padding:12px;border:1px solid #eef6f9">
          <div class="small">Operador: <strong id="pvOperador"></strong> • Turno: <strong id="pvTurno"></strong></div>
          <div class="small">Linha: <strong id="pvLinha"></strong> • Código: <strong id="pvCod"></strong></div>
          <div style="margin-top:8px;max-height:260px;overflow:auto;border-top:1px dashed #eef6f9;padding-top:8px" id="pvList"></div>
          <div style="margin-top:8px" class="small">Totais: Stella: <strong id="pvStella"></strong> — Spaten: <strong id="pvSpaten"></strong> — Geral: <strong id="pvGeral"></strong></div>
          <div style="display:flex;gap:8px;margin-top:10px">
            <button class="primary" id="pvPdf">Baixar PDF</button>
            <button class="ghost" id="pvClose">Fechar</button>
          </div>
        </div>
      </div>

    </div>
  </div>
</div>

<script>
/* -------------------------
   App logic
   - Test mode: 50 items
   - LocalStorage keys: 'bulks_state'
   ------------------------- */

const TOTAL_ITEMS = 50; // versão de teste; troque pra 200 quando pronto

// DOM
const splash = document.getElementById('splash');
const enter = document.getElementById('enter');
const main = document.getElementById('main');
const dateInput = document.getElementById('date');

const startBtn = document.getElementById('startBtn');
const operatorInput = document.getElementById('operator');
const turnoSel = document.getElementById('turnoSel');
const linhaInput = document.getElementById('linha');
const codMatInput = document.getElementById('codMat');

const selection = document.getElementById('selection');
const setup = document.getElementById('setup');
const chooseStella = document.getElementById('chooseStella');
const chooseSpaten = document.getElementById('chooseSpaten');
const backToSetup = document.getElementById('backToSetup');

const control = document.getElementById('control');
const hdrTipo = document.getElementById('hdrTipo');
const hdrMeta = document.getElementById('hdrMeta');
const bigCounter = document.getElementById('bigCounter');
const addBulkBtn = document.getElementById('addBulk');
const resetCounts = document.getElementById('resetCounts');
const listContainer = document.getElementById('listContainer');

const dashStella = document.getElementById('dashStella');
const dashSpaten = document.getElementById('dashSpaten');
const totalRegistered = document.getElementById('totalRegistered');

const backToSelect = document.getElementById('backToSelect');
const exportCsv = document.getElementById('exportCsv');
const exportPdf = document.getElementById('exportPdf');
const openReport = document.getElementById('openReport');

// preview
const reportPreview = document.getElementById('reportPreview');
const pvOperador = document.getElementById('pvOperador');
const pvTurno = document.getElementById('pvTurno');
const pvLinha = document.getElementById('pvLinha');
const pvCod = document.getElementById('pvCod');
const pvList = document.getElementById('pvList');
const pvStella = document.getElementById('pvStella');
const pvSpaten = document.getElementById('pvSpaten');
const pvGeral = document.getElementById('pvGeral');
const pvPdf = document.getElementById('pvPdf');
const pvClose = document.getElementById('pvClose');

// state
let appState = {
  operator: '',
  turno: '',
  date: (new Date()).toLocaleDateString(),
  linha: '',
  codMat: '',
  currentType: null, // 'stella' or 'spaten'
  // items: array of objects { num:1..TOTAL_ITEMS, received:false, rt: '' }
  items: []
};

// storage
const STORAGE_KEY = 'bulks_state_v1';
function saveState(){ localStorage.setItem(STORAGE_KEY, JSON.stringify(appState)); }
function loadState(){
  const raw = localStorage.getItem(STORAGE_KEY);
  if(!raw) return false;
  try{
    const parsed = JSON.parse(raw);
    // maintain compatibility: if items missing, init
    if(!Array.isArray(parsed.items) || parsed.items.length !== TOTAL_ITEMS){
      parsed.items = initItems();
    }
    appState = parsed;
    return true;
  }catch(e){ console.warn('state load err',e); return false; }
}
function initItems(){
  const arr=[];
  for(let i=1;i<=TOTAL_ITEMS;i++) arr.push({num:i,received:false,rt:''});
  return arr;
}

// helpers
function showSplash(val){
  splash.style.display = val? 'flex':'none';
  main.style.display = val? 'none':'block';
}
function showSetup(){ setup.style.display='block'; selection.style.display='none'; control.style.display='none'; reportPreview.style.display='none'; }
function showSelection(){ setup.style.display='none'; selection.style.display='block'; control.style.display='none'; reportPreview.style.display='none';}
function showControl(){ setup.style.display='none'; selection.style.display='none'; control.style.display='block'; reportPreview.style.display='none'; }
function showReportPreview(){ reportPreview.style.display='block'; }

function formatDateTime(d=new Date()){ return d.toLocaleString(); }

// init UI
dateInput.value = appState.date;

// splash enter
enter.onclick = () => {
  showSplash(false);
  showSetup();
};

// load or init
if(!loadState()){
  appState.items = initItems();
  saveState();
} else {
  // if loaded, set date to stored date
  dateInput.value = appState.date;
}

// start
startBtn.onclick = () => {
  const op = operatorInput.value.trim();
  const tr = turnoSel.value;
  if(!op || !tr){ alert('Preencha nome e turno.'); return; }
  appState.operator = op;
  appState.turno = tr;
  appState.date = dateInput.value || (new Date()).toLocaleDateString();
  appState.linha = linhaInput.value.trim();
  appState.codMat = codMatInput.value.trim();
  saveState();
  showSelection();
};

// choose types
chooseStella.onclick = () => { appState.currentType = 'stella'; openControl('Bulk Stella'); }
chooseSpaten.onclick = () => { appState.currentType = 'spaten'; openControl('Bulk Spaten'); }
backToSetup.onclick = () => { showSetup(); }

// open control
function openControl(label){
  hdrTipo.textContent = label;
  hdrMeta.textContent = `${appState.operator} • Turno ${appState.turno} • Linha ${appState.linha || '-'}`;
  renderCounts();
  renderList();
  showControl();
}

// rendering
function renderCounts(){
  const st = appState.items.filter(i=>i.received && i.type==='stella').length * 1; // we store type per item optionally
  // But since we have separate counters via bulk button, we'll keep counters in items: when bulk registered, we mark next unreceived items and set their type
  const totalStella = appState.items.filter(i=>i.received && i.type==='stella').length;
  const totalSpaten = appState.items.filter(i=>i.received && i.type==='spaten').length;
  dashStella.textContent = totalStella;
  dashSpaten.textContent = totalSpaten;
  bigCounter.textContent = appState.items.filter(i=>i.received && i.type===appState.currentType).length;
  totalRegistered.textContent = appState.items.filter(i=>i.received).length;
}

function renderList(){
  listContainer.innerHTML = '';
  // build each item (num, checkbox received, rt select)
  for(let i=0;i<TOTAL_ITEMS;i++){
    const it = appState.items[i];
    const item = document.createElement('div');
    item.className = 'item';

    const num = document.createElement('div'); num.className = 'num'; num.textContent = it.num;
    const mid = document.createElement('div');

    // Received toggle with label of type if set
    const toggleRow = document.createElement('div'); toggleRow.className='toggle';
    const chk = document.createElement('input'); chk.type='checkbox'; chk.checked = !!it.received;
    chk.onchange = () => {
      it.received = chk.checked;
      if(it.received && !it.type) it.type = appState.currentType; // if operator manually checks, tag with current type
      if(!it.received){ it.rt=''; it.type = null; }
      saveState(); renderCounts(); renderList();
    };
    const typeLabel = document.createElement('div'); typeLabel.style.fontSize='13px'; typeLabel.style.marginLeft='6px';
    typeLabel.textContent = it.type? (it.type==='stella'?'Stella':'Spaten') : '—';
    toggleRow.appendChild(chk); toggleRow.appendChild(typeLabel);

    mid.appendChild(toggleRow);

    // RT select
    const rtSel = document.createElement('select'); rtSel.className='small-select';
    const codes = ['','A','B','C','D','E','F','G','H','I','J','K','L','M','N','O','P','Q'];
    codes.forEach(c=>{
      const o = document.createElement('option'); o.value=c; o.textContent = c? `${c}` : 'RT';
      rtSel.appendChild(o);
    });
    rtSel.value = it.rt || '';
    rtSel.onchange = ()=>{
      it.rt = rtSel.value;
      saveState();
    };

    // right column: quick set buttons: mark received with current type
    const rightCol = document.createElement('div');
    rightCol.style.display='flex'; rightCol.style.flexDirection='column'; rightCol.style.gap='6px';

    const setBtn = document.createElement('button');
    setBtn.className='ctrl-secondary';
    setBtn.textContent = it.received ? 'Desmarcar' : 'Marcar recebido';
    setBtn.onclick = ()=>{
      it.received = !it.received;
      it.type = it.received? appState.currentType : null;
      if(!it.received) it.rt='';
      saveState(); renderCounts(); renderList();
    };

    rightCol.appendChild(rtSel);
    rightCol.appendChild(setBtn);

    item.appendChild(num);
    item.appendChild(mid);
    item.appendChild(rightCol);

    listContainer.appendChild(item);
  }
}

// When registering a bulk: mark next two available items as received with the current type.
addBulkBtn.onclick = ()=>{
  if(!appState.currentType){ alert('Tipo não definido'); return; }
  // find next two unreceived indices
  let cnt = 0;
  for(let i=0;i<TOTAL_ITEMS && cnt<2;i++){
    if(!appState.items[i].received){
      appState.items[i].received = true;
      appState.items[i].type = appState.currentType;
      cnt++;
    }
  }
  if(cnt===0){ alert('Não há items livres para registrar.'); return; }
  saveState(); renderCounts(); renderList();
};

// reset counts for current type (confirm)
resetCounts.onclick = ()=>{
  if(!confirm('Zerar todas as marcações (toda a lista)?')) return;
  appState.items = initItems();
  saveState(); renderCounts(); renderList();
};

// back
backToSelect.onclick = ()=>{ showSelection(); }

// export CSV
exportCsv.onclick = ()=>{
  const rows = [];
  rows.push(['num','received','type','rt']);
  appState.items.forEach(i=>{
    rows.push([i.num, i.received?1:0, i.type||'', i.rt||'']);
  });
  const csv = rows.map(r=> r.map(c => `"${String(c).replace(/"/g,'""')}"`).join(',')).join('\n');
  const blob = new Blob([csv], {type:'text/csv;charset=utf-8;'});
  const url = URL.createObjectURL(blob);
  const a = document.createElement('a'); a.href = url; a.download = `bulks_${appState.operator||'op'}_${Date.now()}.csv`; document.body.appendChild(a); a.click(); a.remove();
  URL.revokeObjectURL(url);
};

// build preview content
function buildPreview(){
  pvOperador.textContent = appState.operator;
  pvTurno.textContent = appState.turno;
  pvLinha.textContent = appState.linha || '-';
  pvCod.textContent = appState.codMat || '-';
  pvList.inne