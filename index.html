<!DOCTYPE html>
<html lang="pt-br">
<head>
<meta charset="utf-8" />
<meta name="viewport" content="width=device-width,initial-scale=1" />
<title>Controle de Bulks - Ambev</title>

<!-- jsPDF est√°vel -->
<script src="https://cdn.jsdelivr.net/npm/jspdf@2.5.1/dist/jspdf.umd.min.js"></script>

<style>
  *{box-sizing:border-box}
  body{
    margin:0;font-family:Inter, "Segoe UI", Roboto, sans-serif;
    background:linear-gradient(135deg,#004aad,#0078ff);
    min-height:100vh;display:flex;align-items:center;justify-content:center;
    color:#222;
  }
  .app{
    width:95%;max-width:480px;background:#fff;border-radius:12px;box-shadow:0 10px 30px rgba(0,0,0,.18);
    overflow:hidden;
  }
  header{background:#004aad;color:#fff;padding:18px;text-align:center;font-weight:700}
  .content{padding:18px}
  label{display:block;margin-top:8px;font-weight:600}
  input,select{width:100%;padding:10px;margin-top:6px;border-radius:8px;border:1px solid #ccc}
  .btn{width:100%;padding:12px;border-radius:10px;border:none;background:#0078ff;color:#fff;font-weight:700;margin-top:12px;cursor:pointer}
  .btn.secondary{background:#ddd;color:#333}
  h2{color:#004aad;margin:8px 0 12px}
  .counter{font-size:56px;color:#004aad;text-align:center;margin:12px 0;font-weight:800}
  .tabela{background:#f5f7fa;border-radius:8px;padding:8px;margin-top:12px}
  .tabela .row{display:flex;justify-content:space-between;padding:6px 8px;border-bottom:1px solid #e6e9ef}
  .tabela .row.total{font-weight:700}
  .hidden{display:none}
</style>
</head>
<body>
  <div class="app">
    <header>Controle de Bulks - Ambev</header>
    <div class="content">
      <div id="tela-inicial">
        <label>Operador</label>
        <input id="operador" placeholder="Seu nome"/>
        <label>Turno</label>
        <select id="turno">
          <option value="">Selecione...</option>
          <option>Turno A</option>
          <option>Turno B</option>
          <option>Turno C</option>
        </select>
        <button id="iniciar" class="btn">Iniciar Controle</button>
      </div>

      <div id="tela-selecao" class="hidden">
        <h2>Selecione o Bulk</h2>
        <button id="bulk-stella" class="btn">Bulk Stella üç∫</button>
        <button id="bulk-spaten" class="btn">Bulk Spaten üç∫</button>
        <button id="voltar-inicio" class="btn secondary">Voltar</button>
      </div>

      <div id="tela-controle" class="hidden">
        <h2 id="tipo-titulo">Bulk</h2>
        <div class="counter" id="contador">0</div>
        <button id="add" class="btn">+2 Bulks</button>
        <button id="remove" class="btn secondary">-2 Corrigir</button>

        <div class="tabela" id="resumo-horas" aria-live="polite"></div>

        <button id="gerar-pdf" class="btn">Gerar Relat√≥rio (PDF)</button>
        <button id="voltar" class="btn secondary">Voltar</button>
      </div>
    </div>
  </div>

<script>
window.addEventListener('load', ()=> {
  const { jsPDF } = window.jspdf;

  // estado
  let operador = '';
  let turno = '';
  let tipoAtual = '';
  // Estrutura: { stella: { total: 0, porHora: { "08:00": 6, ... } }, spaten: {...} }
  let contagens = JSON.parse(localStorage.getItem('contagensBulkProf')) || {
    stella: { total:0, porHora:{} },
    spaten: { total:0, porHora:{} }
  };

  // elementos
  const telaInicial = document.getElementById('tela-inicial');
  const telaSelecao = document.getElementById('tela-selecao');
  const telaControle = document.getElementById('tela-controle');
  const operadorIn = document.getElementById('operador');
  const turnoIn = document.getElementById('turno');
  const contadorEl = document.getElementById('contador');
  const tipoTitulo = document.getElementById('tipo-titulo');
  const resumoHoras = document.getElementById('resumo-horas');

  // navega√ß√£o
  function mostrar(t){
    [telaInicial,telaSelecao,telaControle].forEach(el => el.classList.add('hidden'));
    if(t==='inicial') telaInicial.classList.remove('hidden');
    if(t==='selecao') telaSelecao.classList.remove('hidden');
    if(t==='controle') telaControle.classList.remove('hidden');
  }

  document.getElementById('iniciar').onclick = () => {
    operador = operadorIn.value.trim();
    turno = turnoIn.value;
    if(!operador || !turno) return alert('Preencha operador e turno.');
    mostrar('selecao');
  };
  document.getElementById('voltar-inicio').onclick = ()=> mostrar('inicial');
  document.getElementById('voltar').onclick = ()=> mostrar('selecao');

  document.getElementById('bulk-stella').onclick = ()=> abrirControle('stella');
  document.getElementById('bulk-spaten').onclick = ()=> abrirControle('spaten');

  function abrirControle(tipo){
    tipoAtual = tipo;
    tipoTitulo.textContent = tipo==='stella' ? 'Bulk Stella üç∫' : 'Bulk Spaten üç∫';
    contadorEl.textContent = contagens[tipo].total || 0;
    atualizarResumoNaTela();
    mostrar('controle');
  }

  function horaKey(){
    // registra por hora no formato HH:00 para agrupar por hora
    const d = new Date();
    return d.getHours().toString().padStart(2,'0') + ':00';
  }

  function salvar(){
    localStorage.setItem('contagensBulkProf', JSON.stringify(contagens));
  }

  document.getElementById('add').onclick = () => {
    if(!tipoAtual) return;
    const h = horaKey();
    contagens[tipoAtual].porHora[h] = (contagens[tipoAtual].porHora[h] || 0) + 2;
    contagens[tipoAtual].total = (contagens[tipoAtual].total || 0) + 2;
    salvar();
    contadorEl.textContent = contagens[tipoAtual].total;
    atualizarResumoNaTela();
  };

  document.getElementById('remove').onclick = () => {
    if(!tipoAtual) return;
    // corrigir: subtrai da HORA ATUAL (comportamento simples). 
    const h = horaKey();
    const exists = contagens[tipoAtual].porHora[h] || 0;
    if(contagens[tipoAtual].total <= 0) return;
    // tenta remover da hora atual; se n√£o houver, remove do total mas n√£o abaixo de zero
    if(exists >= 2){
      contagens[tipoAtual].porHora[h] = exists - 2;
      if(contagens[tipoAtual].porHora[h] <= 0) delete contagens[tipoAtual].porHora[h];
    } else {
      // se na hora atual n√£o tem, procura a √∫ltima hora registrada para ajustar (mais √∫til)
      const horas = Object.keys(contagens[tipoAtual].porHora).sort().reverse();
      let removed = false;
      for(const hh of horas){
        if(contagens[tipoAtual].porHora[hh] >= 2){
          contagens[tipoAtual].porHora[hh] -= 2;
          if(contagens[tipoAtual].porHora[hh] <= 0) delete contagens[tipoAtual].porHora[hh];
          removed = true;
          break;
        }
      }
      if(!removed){
        // nada a remover por hora, ent√£o apenas garante n√£o ficar negativo
      }
    }
    contagens[tipoAtual].total = Math.max(0, (contagens[tipoAtual].total || 0) - 2);
    salvar();
    contadorEl.textContent = contagens[tipoAtual].total;
    atualizarResumoNaTela();
  };

  function atualizarResumoNaTela(){
    const data = contagens[tipoAtual].porHora || {};
    const horas = Object.keys(data).sort();
    let html = `<div class="row"><div><strong>Hora</strong></div><div><strong>Quantidade</strong></div></div>`;
    if(horas.length===0){
      html += `<div class="row"><div>Sem registros</div><div>‚Äî</div></div>`;
    } else {
      horas.forEach(h=>{
        html += `<div class="row"><div>${h}</div><div>${data[h]}</div></div>`;
      });
    }
    html += `<div class="row total"><div>Total</div><div>${contagens[tipoAtual].total||0}</div></div>`;
    resumoHoras.innerHTML = html;
  }

  // Gera√ß√£o do PDF (profissional, sem usar imagens remotas -> evita CORS)
  document.getElementById('gerar-pdf').onclick = () => {
    if(!tipoAtual) return alert('Selecione um bulk antes de gerar o PDF.');
    const doc = new jsPDF({unit:'mm', format:'a4'});
    const margem = 15;
    let y = 18;

    // Cabe√ßalho colorido (ret√¢ngulo) + "logo" text-based (evita CORS)
    doc.setFillColor(0,74,173); // azul ambev
    doc.rect(0,0,210,28,'F');
    doc.setTextColor(255,255,255);
    doc.setFontSize(18);
    doc.text('Relat√≥rio de Bulks', margem, 10+7);
    doc.setFontSize(11);
    doc.text('AMBEV', 170, 10+7); // "logo" simples

    // Informa√ß√µes do relat√≥rio
    doc.setTextColor(0,0,0);
    y = 38;
    doc.setFontSize(11);
    doc.text(`Operador: ${operador}`, margem, y);
    doc.text(`Turno: ${turno}`, 110, y);
    y += 7;
    doc.text(`Tipo: ${tipoAtual === 'stella' ? 'Stella' : 'Spaten'}`, margem, y);
    doc.text(`Data: ${new Date().toLocaleString()}`, 110, y);
    y += 10;

    // Tabela - cabe√ßalho
    const tableX = margem;
    const tableW = 210 - margem*2;
    doc.setFillColor(0,74,173);
    doc.setDrawColor(200);
    doc.setTextColor(255,255,255);
    doc.rect(tableX, y, tableW, 8, 'F');
    doc.setFontSize(11);
    doc.text('Hora', tableX + 6, y + 6);
    doc.text('Quantidade', tableX + tableW - 40, y + 6);
    y += 12;
    doc.setTextColor(0,0,0);

    // Linhas com dados
    const dataHora = contagens[tipoAtual].porHora || {};
    const horas = Object.keys(dataHora).sort();
    if(horas.length === 0){
      doc.text('Sem registros', tableX + 6, y);
      y += 8;
    } else {
      doc.setFontSize(10);
      horas.forEach(h=>{
        if(y > 275){ doc.addPage(); y = 20; } // nova p√°gina se necess√°rio
        doc.text(h, tableX + 6, y);
        doc.text(String(dataHora[h]), tableX + tableW - 40, y);
        y += 8;
      });
    }

    // Linha de total destacada
    if(y > 275){ doc.addPage(); y = 20; }
    doc.setFont(undefined, 'bold');
    doc.text('Total', tableX + 6, y + 4);
    doc.text(String(contagens[tipoAtual].total || 0), tableX + tableW - 40, y + 4);
    doc.setFont(undefined, 'normal');

    // Rodap√© opcional
    const footerY = 287;
    doc.setFontSize(9);
    doc.setTextColor(120);
    doc.text('Relat√≥rio gerado por sistema - Controle de Bulks', margem, footerY);

    // Salvar
    const filename = `Relatorio_${tipoAtual}_${operador.replace(/\s+/g,'_')}_${Date.now()}.pdf`;
    try{
      doc.save(filename);
    }catch(err){
      alert('Erro ao gerar o PDF: ' + (err.message || err));
      console.error(err);
    }
  };

  // inicializa tela
  mostrar('inicial');
});
</script>
</body>
</html>